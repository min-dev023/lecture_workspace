<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    #wrapper{
        width: 1250px;
        height: 700px;
        background-color: lightgray;
        margin: auto;
    }
    #aside {
        width: 150px;
        height: 100%;
        background-color: lightgreen;
        float: left;
    }
    #aside * {
        width: 90%;
        margin-left: 8px;
    }
    #content {
        width: 1100px;
        height: 100%;
        background-color: lightyellow;
        float: left;
        background-image: url(../images/vene.jpeg);
        background-size: 1100px 700px;
        position: relative;
    }
    #stage{
        width: 100%;
        height: 100%;
    }
    #box {
        width: 150px;
        height: 150px;
        background-color: greenyellow;
        position: relative; /* hp 때문에*/
        margin-top: 20px;
    }
</style>
<script src="../lib/common.js"></script>
<script src="./js/Word.js"></script>
<script src="./js/HP.js"></script>
<script>
    // 프로그래밍 언어에서 메모장의 데이터를 바로 사용할 수 없으므로,
    // 메모장 파일을 읽어들여, 그 결과물인 JSON문자열을 파싱한 후, 객체로 반환 받아서 사용하자.
    // 단 js가 파일에 대한 접근은 불가능하므로, 크롬브라우저가 사용자에게
    // 수락을 받은 그 결과를 얻어와서 처리해야 함.

    let wordArray; // 프로그램이 종료될 때까지 총 4레벨까지 게임 가능한 데이터베이스를 담고 있을 전역변수
    let st;
    let wordList = []; // 단어 스트링 자체가 아닌, 단어 객체 인스턴스가 담겨질 배열
    let speed = 600; // 게임의 속도를 좌우하는 변수 (레벨이 올라갈수록 숫자 감소)
    let level = 0; // 몇 번재 배열을 접근(층수 접근) 변수
    let hpArray = []; // HP 인스턴스를 보관할 배열

    function loadData(e){
        console.log(e);
        let file = e.target.files[0]; // 사용자가 수락한 그 파일
        
        // 파일의 내용을 읽기
        let reader = new FileReader();
        reader.onload =function(data){
            console.log("메모장 읽은 결과 : ", data);
            let jsonString = data.target.result; // 메모장에 작성된 바로 그 문자열들..
            let obj = JSON.parse(jsonString); // 문자열이므로, 해석해야함 (해석 결과로써 객체로 반환)

            console.log(obj); // js의 객체 리터럴이 출력되어야 함d

            wordArray = obj.wordList; // 전역변수에 보관...

            createWord();

            document.querySelector("button").style.disabled = "enable";

            // for(let i = 0; i < obj.wordList.length; i++){
            //     console.log(obj.wordList[i]);

            // }
        }

        reader.readAsText(file); // 문서파일이기 때문
    }

    function createWord(){
        let content = document.getElementById("content");

        for(let i = 0; i < wordArray[level].length; i++) {
            let word = new Word(content,70 + (i * 100), getRandomByRange(-200, -10) +200, wordArray[level][i], "red");
            wordList.push(word); // 배열에 인스턴스 추가하기.
        }
    }

    // 단어를 알아맞추는 과정에서 wordList의 길이가 0에 도달하면,
    // 이 판을 다 클리어 했다고 판단하여, 레벨 올리기.
    function checkLevel() {
        // createWord();
        if(wordList.length == 0) {
            alert(level + 1 + "레벨 통과!")
            speed -= 200;
            level++;
            createWord();
        }
    }

    // 사용자가 입력한 단어 비교해서 제거 등의 처리...
    function checkText(obj) {
        // 화면의 배열 수 만큼 비교
        for(let i = 0; i < wordList.length; i++){
            if(wordList[i].text == obj.value) {
                wordList[i].span.style.color = "blue";

                // 제거하기 (화면에서 제거 + 배열에서도 제거)
                let content = document.getElementById("content");
                content.removeChild(wordList[i].span);

                wordList.splice(i, 1); // 배열에서 제거

                checkLevel();
            }
        }
    }

    function nextStep() {
        // 모든 단어를 대상으로 tick(), render()

        for(let i = 0; i < wordList.length; i++) {
            wordList[i].tick();
            wordList[i].render();
        }
    }

    // 9개의 HP 인스턴스 생성하기
    function createHP() {
        for(let i = 0; i < 3; i++) {
            for(let j = 0; j < 3; j++) {
                hpArray.push(new HP(document.getElementById("box"), a*48, i*48, 48, 48, "red", "purple"));
            }
        }
    }
    
    function gameLoop() {
        console.log("루프");
        nextStep(); // 단어가 하나씩 내려오도록.
    }

    function init() {
        document.querySelector("input[type='file']").addEventListener("change", function(e){
            loadData(e);
        });

        document.querySelector("#aside button").addEventListener("click", function(){
            if(st == undefined) { // 가동된 인터벌이 없다면..
                st = setInterval(gameLoop, speed); // 새롭게 가동
                this.innerText = "Pause";
            } else {
                clearInterval(st);
                st = undefined; // 삭제 후 다시 초기화..
                this.innerText = "Start";
            }
        });

        document.querySelector("#aside input[type='text']").addEventListener("keyup", function(e){
            if(e.keyCode == 13) { // 엔터를 쳤다면
                // 사용자가 입력한 단어와 화면에 생존해 있는 단어 인스턴스 내부의
                // span의 innerText을 비교하자.
                checkText(this); // textBox를 들고감

                document.querySelector("#aside input[type='text']").innerText = "";
            }
        });

        createHP();
    }
    addEventListener("load", function(){
        init();
    });
</script>
<body>
    <div id="wrapper">
        <div id="aside">
            <input type="file">
            <button>Start</button>
            <input type="text" placeholder="단어 입력">
            <div id="box">

            </div>
        </div>
        <div id="content">
        </div>
    </div>
</body>
</html>